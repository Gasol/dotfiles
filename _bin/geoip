#!/usr/bin/env php
<?php

set_error_handler(function($errno, $errstr) {
    static $geoip_notice_host_not_found = 'geoip_country_code_by_name(): Host 127.0.0.1 not found';
    $boundary = 3;
    $similar_threshold = strlen($geoip_notice_host_not_found) - strlen('255.255.255.255') - $boundary;

    // Return true to ignore notice generated by geoip
    return similar_text($errstr, $geoip_notice_host_not_found) >= $similar_threshold;
}, E_NOTICE);


if ($has_ip2location = extension_loaded('ip2location')) {
    ip2location_open('/usr/local/share/IP2Loc/IP-COUNTRY.BIN'); // FIXME
    ip2location_open_mem(IP2LOCATION_FILE_IO);
} elseif (!extension_loaded('geoip')) {
    die("You have to install at least one of pecl-ip2location or pecl-geoip\n");
}

$stream_temp = fopen('php://temp', 'r+') or die("Can't open temp file\n");
$streams = array($stream_temp);
!posix_isatty(STDIN) and $streams[] = STDIN;

for ($i = 1; $i < $argc; $i++) {
    $arg = $argv[$i];
    if (is_file($arg)) {
        $file = $arg;
        $stream_fp = fopen($file, 'r') and $streams[] = $stream_fp;
    } elseif (ip2long($arg)) {
        $ip_address = $arg;
        fwrite($stream_temp, "$ip_address\n");
    }
}
assert(rewind($stream_temp));

$country_not_found = 'XX';

foreach ($streams as $stream) {
    while (false !== ($line = fgets($stream))) {
        $ip_address = trim($line);
        if (empty($ip_address)) {
            continue;
        }

        $geoip_country = geoip_country_code_by_name($ip_address) ?: $country_not_found;
        $has_ip2location and $ip2loc_country = ip2location_get_country_short($ip_address);
        if (isset($ip2loc_country) || '-' === $ip2loc_country) {
            $ip2loc_country = $country_not_found;
        }

        $out_line = str_pad($ip_address, 15) . "\t" .
                    "$geoip_country\t" .
                    "$ip2loc_country\n";
        echo $out_line;
    }

    if (!feof($stream)) {
        trigger_error($stream . " doesn't reach end of file", E_USER_WARNING);
    }
    fclose($stream);
}
